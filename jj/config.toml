[user]
name = "Oliver Nordbjerg"
email = "hi@notbjerg.me"

[signing]
behavior = "own"
backend = "gpg"

[revsets]
'default()' = 'coalesce(trunk(),root())::present(@) | ancestors(visible_heads() & recent(), 5)'
'closest_bookmark(to)' = 'heads(::to & bookmarks())'
log = "present(@) | ancestors(immutable_heads().., 2) | present(trunk())"

[revset-aliases]
remote = "@ | ancestors(remote_bookmarks(), 5)"
tracked = "@ | ancestors(bookmarks(), 5)"
mine = "@ | ancestors(mine(), 5)"

[aliases]
tug = ["bookmark", "move", "--from", "heads(::@- & bookmarks())", "--to", "@-"]
gpc = ["util", "exec", "--", "bash", "-c", """
set -euo pipefail

# Get the log of changes from trunk to current
changes=$(jj log -r 'trunk()..@' --no-graph -T 'description ++ "\n"' 2>/dev/null | head -20)

if [ -z "$changes" ]; then
  echo "No changes between trunk and @"
  exit 1
fi

# Use amp rush mode to generate a short bookmark name
name=$(echo "$changes" | amp --mode rush -x "Generate a very short git branch name (2-4 words, lowercase, hyphen-separated) that summarizes these commit messages. Output ONLY the branch name, nothing else. No prefix, no quotes, no explanation.")

if [ -z "$name" ]; then
  echo "Failed to generate bookmark name"
  exit 1
fi

bookmark="onbjerg/$name"
echo "Creating bookmark: $bookmark"

# Create and push atomically using --named
jj git push --named "$bookmark=@" "$@"
""", "--"]

[fix.tools.rustfmt]
command = ["rustfmt", "+nightly", "--emit", "stdout"]
patterns = ["glob:'**/*.rs'"]

[ui]
default-command = ["log"]

editor = "zeditor -w"
diff-editor = ["zed", "--wait", "--diff", "$left", "$right"]
conflict-marker-style = "git" # Required for zed since there is no native jj conflict marker support.

diff-formatter = ["difft", "--color=always", "$left", "$right"]

[git]
write-change-id-header = true
sign-on-push = true

[remotes.origin]
auto-track-bookmarks = "glob:onbjerg/*"

[templates]
git_push_bookmark = '"onbjerg/push-" ++ change_id.short()'
